<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>정기청소 견적 계산기</title>
  <style>
    :root{--bg:#f7f8fa;--card:#ffffff;--text:#111827;--muted:#6b7280;--pri:#2563eb;--pri-weak:#dbeafe;--ring:#93c5fd}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:"Pretendard","Noto Sans KR",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple SD Gothic Neo","Malgun Gothic",sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));backdrop-filter:saturate(1.5) blur(6px);border-bottom:1px solid #eef2f7;z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:0}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px;margin-top:18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #eef2f7;border-radius:16px;box-shadow:0 6px 20px rgba(17,24,39,.05)}
    .section{padding:18px}
    h2{font-size:18px;margin:0 0 12px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:var(--muted)}
    input[type="number"], select, input[type="text"], textarea{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-size:15px}
    textarea{min-height:64px;resize:vertical}
    .chk{display:flex;align-items:center;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--pri-weak);color:var(--pri);border-radius:999px;padding:6px 10px;font-size:12px}
    .muted{color:var(--muted)}
    .money{font-variant-numeric:tabular-nums}
    .total{font-size:28px;font-weight:700}
    .btn{appearance:none;border:0;background:var(--pri);color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#1118270d;color:#111827}
    .btn.ghost{background:#ffffff;border:1px solid #e5e7eb;color:#111827}
    .btn.icon{padding:8px 10px}
    .kicker{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:#eef2f7;margin:14px 0}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #eef2f7;text-align:right}
    th:first-child,td:first-child{text-align:left}
    .sticky-cta{position:sticky;bottom:0;background:linear-gradient(0deg,#fff,rgba(255,255,255,.92));border-top:1px solid #eef2f7;padding:12px 18px;border-bottom-left-radius:16px;border-bottom-right-radius:16px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .space-card{border-top:1px dashed #e5e7eb;margin-top:12px;padding-top:12px}
    .space-head{display:flex;align-items:center;gap:8px;justify-content:space-between}
    .space-title{display:flex;align-items:center;gap:8px}
    .hint{font-size:12px;color:#6b7280}
    .hide{display:none}
    .badge{display:inline-block;padding:3px 8px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:12px}
    .test-pass{background:#ecfdf5;color:#065f46}
    .test-fail{background:#fef2f2;color:#991b1b}
    .extra-row{display:grid;grid-template-columns:1fr 160px 40px;gap:8px;align-items:center}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <h1>정기청소 견적 계산기</h1>
      <div class="pill">여러 공간(건물) 동시 계산 · 클린앤여락</div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <!-- 좌: 입력 영역 -->
      <section class="card">
        <div class="section">
          <h2>공간들 <span class="badge" id="spaceCount">0곳</span> <span id="testStatus" class="badge" style="display:none"></span></h2>
          <div style="display:flex;gap:8px;margin-bottom:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" id="addSpace" type="button">+ 공간 추가</button>
            <button class="btn ghost" id="dupLast" type="button">마지막 공간 복제</button>
            <label class="chk" style="margin-left:auto"><input id="vatToggle" type="checkbox"/> 부가세 10% 포함</label>
          </div>
          <div id="spaces"></div>
        </div>

        <div class="sticky-cta">
          <div>
            <div class="kicker">예상 월 총액</div>
            <div class="total money" id="monthlyTotal">0원</div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn secondary" id="share" type="button">링크 공유</button>
            <button class="btn" id="print" type="button">견적서 출력(엑셀)</button>
          </div>
        </div>
      </section>

      <!-- 우: 결과 영역 -->
      <aside class="card">
        <div class="section">
          <h2>요약</h2>
          <div class="small muted" id="summary">공간을 추가하고 값을 입력하세요.</div>
          <div class="hr"></div>

          <h3 style="margin:0 0 8px 0;font-size:16px">공간별 합계</h3>
          <table id="tblSummary">
            <thead>
              <tr>
                <th>공간명</th>
                <th>회당</th>
                <th>방문/월</th>
                <th>할인</th>
                <th>추가(月)</th>
                <th>월 합계</th>
              </tr>
            </thead>
            <tbody></tbody>
            <tfoot>
              <tr>
                <th colspan="5">월 합계(부가세 제외)</th>
                <th id="monthlyNoVat">0원</th>
              </tr>
              <tr id="vatRow" class="hide">
                <th colspan="5">부가세 10%</th>
                <th id="vatAmt">0원</th>
              </tr>
              <tr id="grandRow" class="hide">
                <th colspan="5">총 청구액(부가세 포함)</th>
                <th id="grandTotal">0원</th>
              </tr>
            </tfoot>
          </table>

          <div class="hr"></div>
          <div id="details"></div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    // ===== 상태 =====
    let spaces = [];
    let idSeq = 1;
    let globalVat = false;

    // ===== 유틸 =====
    const q = (s)=>document.querySelector(s); const qa=(s)=>Array.from(document.querySelectorAll(s));
    const fmt = (n)=> new Intl.NumberFormat('ko-KR').format(Math.round(n||0))+'원';
    const esc = (s)=> String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

    function discountByVisits(v){
      if(v>=28) return 0.15; if(v>=24) return 0.12; if(v>=20) return 0.12; if(v>=12) return 0.08; if(v>=8) return 0.05; return 0;
    }

    function newSpace(){
      return {
        id:'S'+(idSeq++), name:'공간 '+(spaces.length+1),
        // 기본 정보
        pyeong:30, difficulty:1, basePerPyeong:8000,
        // 빈도/할인
        freqPerWeek:1, discountRate:0, discountCustom:false,
        // 주말 가산(개별 설정)
        satOn:false, sunOn:false, satRate:0.10, sunRate:0.20,
        // 선택 항목 토글
        addons:{restroom:false, stairs:false, trash:false, windows:false, officeRooms:false, meetingRooms:false, extras:true},
        // 항목별 값
        restrooms:1, restroomAdd:5000,
        stairsFloors:0, stairsAdd:3000,
        trashLevel:0, trashPrice:10000,
        windows:0, windowInternal:20000,
        officeCount:0, officeUnit:5000,
        meetingCount:0, meetingUnit:7000,
        // 추가 비용(월 정액) & 비고
        extras: [],
        note: ''
      };
    }

    // ===== 렌더링: 추가비용 리스트 (부분 렌더)
    function renderExtrasList(container, sp){
      container.innerHTML = sp.extras.map((ex,idx)=>`
        <div class="extra-row" data-extra-index="${idx}">
          <input data-id="${sp.id}" data-role="extra-label" data-extra-index="${idx}" type="text" placeholder="추가 내용" value="${esc(ex.label)}"/>
          <input data-id="${sp.id}" data-role="extra-amount" data-extra-index="${idx}" type="number" step="500" value="${Number(ex.amount)||0}"/>
          <button class="btn icon" data-action="extra-del" data-id="${sp.id}" data-extra-index="${idx}" type="button">✕</button>
        </div>
      `).join('');
    }

    // ===== 렌더링: 공간 카드 =====
    function renderSpaces(){
      q('#spaceCount').textContent = spaces.length+'곳';
      q('#spaces').innerHTML = spaces.map(sp=>{
        const visits = (Number(sp.freqPerWeek)||1)*4;
        const defaultDisc = discountByVisits(visits);
        const showDefault = Math.round(defaultDisc*100);
        const discPercent = Math.round((sp.discountCustom? sp.discountRate : defaultDisc)*100);
        return `
        <div class="space-card" data-id="${sp.id}">
          <div class="space-head">
            <div class="space-title">
              <input data-id="${sp.id}" data-field="name" type="text" value="${esc(sp.name)}" style="width:200px"/>
            </div>
            <div style="display:flex;gap:6px">
              <button class="btn ghost" data-action="dup" data-id="${sp.id}">복제</button>
              <button class="btn secondary" data-action="del" data-id="${sp.id}">삭제</button>
            </div>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="field"><label>면적(평)</label><input data-id="${sp.id}" data-field="pyeong" type="number" step="0.1" value="${sp.pyeong}"></div>
            <div class="field"><label>난이도</label>
              <select data-id="${sp.id}" data-field="difficulty">
                <option value="1" ${sp.difficulty==1?'selected':''}>보통(×1.00)</option>
                <option value="1.15" ${sp.difficulty==1.15?'selected':''}>약간 어려움(×1.15)</option>
                <option value="1.3" ${sp.difficulty==1.3?'selected':''}>어려움(×1.30)</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="field"><label>단가(원/평)</label><input data-id="${sp.id}" data-field="basePerPyeong" type="number" step="100" value="${sp.basePerPyeong}"></div>
          </div>

          <div class="row" style="margin-top:6px">
            <div class="field"><label>주당 방문 빈도</label>
              <select data-id="${sp.id}" data-field="freqPerWeek">
                ${[1,2,3,4,5,6,7].map(n=>`<option value="${n}" ${sp.freqPerWeek==n?'selected':''}>주 ${n}회</option>`).join('')}
              </select>
              <span class="hint" data-role="default-discount" data-space="${sp.id}">기본 할인: ${showDefault}%</span>
            </div>
            <div class="field"><label>할인율(%) <span class="hint" data-role="default-discount2" data-space="${sp.id}">기본값 ${showDefault}%</span></label>
              <div style="display:flex;gap:6px;align-items:center">
                <input data-id="${sp.id}" data-field="discountRate" type="number" step="1" value="${discPercent}">
                <button class="btn ghost" data-action="reset-discount" data-id="${sp.id}" type="button">기본값</button>
              </div>
            </div>
          </div>

          <div class="row3" style="margin-top:6px">
            <div class="field chk"><input data-id="${sp.id}" data-field="satOn" data-type="bool" type="checkbox" ${sp.satOn?'checked':''}/><label>토 포함(<span data-role="sat-label" data-space="${sp.id}">+${Math.round(sp.satRate*100)}%</span>)</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-field="sunOn" data-type="bool" type="checkbox" ${sp.sunOn?'checked':''}/><label>일 포함(<span data-role="sun-label" data-space="${sp.id}">+${Math.round(sp.sunRate*100)}%</span>)</label></div>
            <div class="field"><label>주말 가산율 조정</label>
              <div class="row">
                <div class="field"><label>토(%)</label><input data-id="${sp.id}" data-field="satRate" type="number" step="1" value="${Math.round(sp.satRate*100)}"></div>
                <div class="field"><label>일(%)</label><input data-id="${sp.id}" data-field="sunRate" type="number" step="1" value="${Math.round(sp.sunRate*100)}"></div>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="hint" style="margin:4px 0 8px">필요한 항목만 켜서 입력하세요.</div>
          <div class="row3">
            <div class="field chk"><input data-id="${sp.id}" data-toggle="restroom" type="checkbox" ${sp.addons.restroom?'checked':''}/><label>화장실 가산</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-toggle="stairs" type="checkbox" ${sp.addons.stairs?'checked':''}/><label>계단 층수</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-toggle="trash" type="checkbox" ${sp.addons.trash?'checked':''}/><label>분리수거</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-toggle="windows" type="checkbox" ${sp.addons.windows?'checked':''}/><label>유리/창문</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-toggle="officeRooms" type="checkbox" ${sp.addons.officeRooms?'checked':''}/><label>사무실(개수×단가)</label></div>
            <div class="field chk"><input data-id="${sp.id}" data-toggle="meetingRooms" type="checkbox" ${sp.addons.meetingRooms?'checked':''}/><label>회의실(개수×단가)</label></div>
          </div>

          <div class="row3" id="sec-restroom-${sp.id}" style="margin-top:8px; ${sp.addons.restroom?'':'display:none'}">
            <div class="field"><label>화장실 개수</label><input data-id="${sp.id}" data-field="restrooms" type="number" step="1" value="${sp.restrooms}"></div>
            <div class="field"><label>1곳 가산(원)</label><input data-id="${sp.id}" data-field="restroomAdd" type="number" step="500" value="${sp.restroomAdd}"></div>
          </div>

          <div class="row3" id="sec-stairs-${sp.id}" style="margin-top:8px; ${sp.addons.stairs?'':'display:none'}">
            <div class="field"><label>계단 층수</label><input data-id="${sp.id}" data-field="stairsFloors" type="number" step="1" value="${sp.stairsFloors}"></div>
            <div class="field"><label>층당 가산(원)</label><input data-id="${sp.id}" data-field="stairsAdd" type="number" step="500" value="${sp.stairsAdd}"></div>
          </div>

          <div class="row3" id="sec-trash-${sp.id}" style="margin-top:8px; ${sp.addons.trash?'':'display:none'}">
            <div class="field"><label>수준</label>
              <select data-id="${sp.id}" data-field="trashLevel">
                <option value="0" ${sp.trashLevel==0?'selected':''}>미포함</option>
                <option value="1" ${sp.trashLevel==1?'selected':''}>보통</option>
                <option value="2" ${sp.trashLevel==2?'selected':''}>대량(×1.5)</option>
              </select>
            </div>
            <div class="field"><label>단가(회당, 원)</label><input data-id="${sp.id}" data-field="trashPrice" type="number" step="500" value="${sp.trashPrice}"></div>
          </div>

          <div class="row3" id="sec-windows-${sp.id}" style="margin-top:8px; ${sp.addons.windows?'':'display:none'}">
            <div class="field"><label>유리/창문</label>
              <select data-id="${sp.id}" data-field="windows">
                <option value="0" ${sp.windows==0?'selected':''}>미포함</option>
                <option value="1" ${sp.windows==1?'selected':''}>내부만</option>
                <option value="2" ${sp.windows==2?'selected':''}>내/외부(×1.8)</option>
              </select>
            </div>
            <div class="field"><label>내부 단가(회당, 원)</label><input data-id="${sp.id}" data-field="windowInternal" type="number" step="500" value="${sp.windowInternal}"></div>
          </div>

          <div class="row3" id="sec-office-${sp.id}" style="margin-top:8px; ${sp.addons.officeRooms?'':'display:none'}">
            <div class="field"><label>사무실 개수</label><input data-id="${sp.id}" data-field="officeCount" type="number" step="1" value="${sp.officeCount}"></div>
            <div class="field"><label>사무실 단가(회당)</label><input data-id="${sp.id}" data-field="officeUnit" type="number" step="500" value="${sp.officeUnit}"></div>
          </div>

          <div class="row3" id="sec-meeting-${sp.id}" style="margin-top:8px; ${sp.addons.meetingRooms?'':'display:none'}">
            <div class="field"><label>회의실 개수</label><input data-id="${sp.id}" data-field="meetingCount" type="number" step="1" value="${sp.meetingCount}"></div>
            <div class="field"><label>회의실 단가(회당)</label><input data-id="${sp.id}" data-field="meetingUnit" type="number" step="500" value="${sp.meetingUnit}"></div>
          </div>

          <div class="hr"></div>
          <div class="field"><label>추가 비용(월 정액)</label>
            <div id="extras-${sp.id}"></div>
            <div style="margin-top:8px"><button class="btn ghost" data-action="extra-add" data-id="${sp.id}" type="button">+ 항목 추가</button></div>
          </div>

          <div class="row" style="margin-top:8px">
            <div class="field" style="grid-column:1/-1"><label>비고</label><textarea data-id="${sp.id}" data-field="note" placeholder="메모를 입력하세요">${esc(sp.note)}</textarea></div>
          </div>
        </div>`;
      }).join('');

      // 각 공간별 추가비용 리스트 부분 렌더
      spaces.forEach(sp=>{
        const cont = q(`#extras-${sp.id}`);
        if(cont) renderExtrasList(cont, sp);
      });
    }

    // ===== 계산 =====
    function calcSpace(sp){
      let rows = [];
      let perVisit = sp.pyeong * sp.basePerPyeong * sp.difficulty; rows.push(['기본(면적×단가×난이도)', `${sp.pyeong}평 × ${fmt(sp.basePerPyeong)} × ${sp.difficulty.toFixed(2)}`, perVisit]);

      if(sp.addons.restroom){ const fee = (Number(sp.restrooms)||0) * (Number(sp.restroomAdd)||0); rows.push(['화장실', `${sp.restrooms}곳 × ${fmt(sp.restroomAdd)}`, fee]); perVisit += fee; }
      if(sp.addons.stairs){ const fee = (Number(sp.stairsFloors)||0) * (Number(sp.stairsAdd)||0); rows.push(['계단', `${sp.stairsFloors}층 × ${fmt(sp.stairsAdd)}`, fee]); perVisit += fee; }
      if(sp.addons.trash){ let fee = 0; if(sp.trashLevel==1) fee = Number(sp.trashPrice)||0; else if(sp.trashLevel==2) fee = (Number(sp.trashPrice)||0)*1.5; rows.push(['분리수거', sp.trashLevel==0?'미포함':(sp.trashLevel==1?'보통':'대량(×1.5)'), fee]); perVisit += fee; }
      if(sp.addons.windows){ let fee = 0; if(sp.windows==1) fee = Number(sp.windowInternal)||0; else if(sp.windows==2) fee = (Number(sp.windowInternal)||0)*1.8; rows.push(['유리/창문', sp.windows==0?'미포함':(sp.windows==1?'내부만':'내/외부(×1.8)'), fee]); perVisit += fee; }
      if(sp.addons.officeRooms){ const fee = (Number(sp.officeCount)||0) * (Number(sp.officeUnit)||0); rows.push(['사무실(개수×단가)', `${sp.officeCount} × ${fmt(sp.officeUnit)}`, fee]); perVisit += fee; }
      if(sp.addons.meetingRooms){ const fee = (Number(sp.meetingCount)||0) * (Number(sp.meetingUnit)||0); rows.push(['회의실(개수×단가)', `${sp.meetingCount} × ${fmt(sp.meetingUnit)}`, fee]); perVisit += fee; }

      // 주말 가산(간이): 월 전체에 가중
      let weekendMultiplier = 1; let weekendDesc = '';
      const sr = Number(sp.satRate)||0; const ur = Number(sp.sunRate)||0;
      if(sp.satOn){ weekendMultiplier*= (1+sr); weekendDesc += `토 +${Math.round(sr*100)}% `; }
      if(sp.sunOn){ weekendMultiplier*= (1+ur); weekendDesc += `일 +${Math.round(ur*100)}%`; }
      if(weekendMultiplier!==1){ const add = perVisit*(weekendMultiplier-1); rows.push(['주말 가산', weekendDesc.trim(), add]); perVisit *= weekendMultiplier; }

      const visits = (Number(sp.freqPerWeek)||1) * 4;
      const defaultDisc = discountByVisits(visits);
      const disc = sp.discountCustom ? (Number(sp.discountRate)||0) : defaultDisc;

      // 추가 비용(월 정액)
      const extrasItems = Array.isArray(sp.extras)? sp.extras : [];
      const extrasMonthly = extrasItems.reduce((a,b)=> a + (Number(b.amount)||0), 0);

      const monthlyBefore = perVisit*visits;
      const monthly = monthlyBefore * (1 - disc) + extrasMonthly;

      return {rows, perVisit, visits, disc, extrasMonthly, extrasItems, monthly};
    }

    function renderResults(){
      // 요약 텍스트
      const names = spaces.map(s=>s.name).join(', ');
      q('#summary').textContent = spaces.length? `공간 ${spaces.length}곳: ${names}` : '공간을 추가하고 값을 입력하세요.';

      // 테이블 요약
      const tbody = q('#tblSummary tbody');
      let monthlySum = 0; let detailHTML = '';
      tbody.innerHTML = spaces.map(sp=>{
        const r = calcSpace(sp); monthlySum += r.monthly;
        detailHTML += `
          <div class="section" style="padding:10px 0">
            <div style="font-weight:700;margin-bottom:6px">${esc(sp.name)}</div>
            <table>
              <thead><tr><th>항목</th><th>단가/산식</th><th>금액</th></tr></thead>
              <tbody>
                ${r.rows.map(x=>`<tr><td>${x[0]}</td><td>${x[1]}</td><td class="money">${fmt(x[2])}</td></tr>`).join('')}
                <tr><td colspan="3"></td></tr>
                ${r.extrasItems.length? r.extrasItems.map(it=>`<tr><td>추가(월)</td><td>${esc(it.label||'-')}</td><td class="money">${fmt(it.amount||0)}</td></tr>`).join('') : ''}
              </tbody>
              <tfoot>
                <tr><th colspan="2">회당 합계</th><th class="money">${fmt(r.perVisit)}</th></tr>
                <tr><th colspan="2">방문/월 · 할인</th><th>${r.visits}회 · ${Math.round(r.disc*100)}%</th></tr>
                ${r.extrasItems.length? `<tr><th colspan="2">추가 합계(월)</th><th class="money">${fmt(r.extrasMonthly)}</th></tr>`:''}
                <tr><th colspan="2">월 합계</th><th class="money">${fmt(r.monthly)}</th></tr>
              </tfoot>
            </table>
            ${sp.note? `<div class="hint" style="margin-top:6px">비고: ${esc(sp.note)}</div>`:''}
          </div>`;
        return `<tr>
          <td>${esc(sp.name)}</td>
          <td class="money">${fmt(r.perVisit)}</td>
          <td>${r.visits}</td>
          <td>${Math.round(r.disc*100)}%</td>
          <td class="money">${fmt(r.extrasMonthly)}</td>
          <td class="money">${fmt(r.monthly)}</td>
        </tr>`;
      }).join('');

      q('#details').innerHTML = detailHTML || '<div class="muted">상세 내역은 공간 추가 후 표시됩니다.</div>';

      q('#monthlyNoVat').textContent = fmt(monthlySum);
      const vatOn = globalVat; const vatAmt = vatOn ? monthlySum*0.1 : 0; const grand = monthlySum + vatAmt;
      q('#vatRow').classList.toggle('hide', !vatOn);
      q('#grandRow').classList.toggle('hide', !vatOn);
      q('#vatAmt').textContent = fmt(vatAmt);
      q('#grandTotal').textContent = fmt(grand);
      q('#monthlyTotal').textContent = fmt(vatOn? grand : monthlySum);
    }

    // ===== 이벤트 바인딩 =====
    function bindSpaces(){
      const cont = q('#spaces');

      function updateInlineHints(id){
        const sp = spaces.find(x=>x.id===id); if(!sp) return;
        const visits = (Number(sp.freqPerWeek)||1)*4;
        const def = discountByVisits(visits);
        const span1 = cont.querySelector(`[data-role="default-discount"][data-space="${id}"]`);
        const span2 = cont.querySelector(`[data-role="default-discount2"][data-space="${id}"]`);
        if(span1) span1.textContent = `기본 할인: ${Math.round(def*100)}%`;
        if(span2) span2.textContent = `기본값 ${Math.round(def*100)}%`;
        if(!sp.discountCustom){
          const discInput = cont.querySelector(`input[data-field="discountRate"][data-id="${id}"]`);
          if(discInput) discInput.value = Math.round(def*100);
        }
      }
      function updateWeekendLabels(id){
        const sp = spaces.find(x=>x.id===id); if(!sp) return;
        const sat = cont.querySelector(`[data-role="sat-label"][data-space="${id}"]`);
        const sun = cont.querySelector(`[data-role="sun-label"][data-space="${id}"]`);
        if(sat) sat.textContent = `+${Math.round((Number(sp.satRate)||0)*100)}%`;
        if(sun) sun.textContent = `+${Math.round((Number(sp.sunRate)||0)*100)}%`;
      }

      function handleFieldChange(e){
        const id = e.target.getAttribute('data-id');
        if(!id) return; 
        const sp = spaces.find(x=>x.id===id);
        if(!sp) return;
        
        // 추가 항목 개별 입력 처리
        const exIdxAttr = e.target.getAttribute('data-extra-index');
        const role = e.target.getAttribute('data-role');
        if(role==='extra-label' && exIdxAttr!==null){ sp.extras[Number(exIdxAttr)].label = e.target.value; save(); renderResults(); return; }
        if(role==='extra-amount' && exIdxAttr!==null){ sp.extras[Number(exIdxAttr)].amount = Number(e.target.value)||0; save(); renderResults(); return; }

        const field = e.target.getAttribute('data-field'); if(!field) return;
        let val = e.target.value;
        if(['pyeong','difficulty','freqPerWeek','restrooms','restroomAdd','stairsFloors','stairsAdd','trashLevel','trashPrice','windows','windowInternal','officeCount','officeUnit','meetingCount','meetingUnit'].includes(field)){
          val = Number(val);
        }
        if(['satOn','sunOn'].includes(field)){
          val = e.target.checked;
        }
        if(['satRate','sunRate'].includes(field)){
          val = (Number(val)||0)/100;
        }
        if(field==='discountRate'){
          sp.discountRate = (Number(val)||0)/100; sp.discountCustom = true; save(); renderResults(); return;
        }
        sp[field] = val;
        save();
        // 부분 UI 업데이트 (전체 재렌더 방지해 포커스 유지)
        if(field==='freqPerWeek'){ updateInlineHints(id); }
        if(field==='satRate' || field==='sunRate'){ updateWeekendLabels(id); }
        renderResults();
      }

      cont.addEventListener('input', handleFieldChange);
      cont.addEventListener('change', handleFieldChange); // select 변경 반영

      cont.addEventListener('change', (e)=>{
        const id = e.target.getAttribute('data-id'); 
        const sp = spaces.find(x=>x.id===id); 
        if(!sp) return;
        const toggleKey = e.target.getAttribute('data-toggle');
        if(toggleKey){
          sp.addons[toggleKey] = e.target.checked; 
          save(); 
          // 섹션 표시/숨김만 갱신 (포커스 보존)
          const secIdMap = {restroom:'sec-restroom', stairs:'sec-stairs', trash:'sec-trash', windows:'sec-windows', officeRooms:'sec-office', meetingRooms:'sec-meeting'};
          const sec = q(`#${secIdMap[toggleKey]}-${id}`);
          if(sec) sec.style.display = e.target.checked ? '' : 'none';
          renderResults();
        }
      });

      cont.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn || !cont.contains(btn)) return;
        e.preventDefault();
        const act = btn.getAttribute('data-action');
        const id = btn.getAttribute('data-id') || btn.closest('.space-card')?.getAttribute('data-id');
        if(!id) return;

        if(act==='reset-discount'){
          const sp = spaces.find(x=>x.id===id); if(!sp) return;
          const visits=(Number(sp.freqPerWeek)||1)*4; 
          sp.discountRate = discountByVisits(visits); 
          sp.discountCustom=false; 
          save(); 
          updateInlineHints(id); 
          renderResults();
          return;
        }

        if(act==='extra-add'){
          const sp = spaces.find(x=>x.id===id); if(!sp) return;
          sp.extras.push({label:'', amount:0}); 
          save();
          const contExtras = q(`#extras-${sp.id}`); 
          if(contExtras) renderExtrasList(contExtras, sp);
          renderResults();
          // 새로 추가된 라벨 입력에 포커스
          const rows = contExtras ? contExtras.querySelectorAll('.extra-row') : null;
          if(rows && rows.length){ rows[rows.length-1].querySelector('input[data-role="extra-label"]')?.focus(); }
          return;
        }

        if(act==='extra-del'){
          const sp = spaces.find(x=>x.id===id); if(!sp) return;
          const idx = Number(btn.getAttribute('data-extra-index'));
          if(Number.isFinite(idx)){
            sp.extras.splice(idx,1); 
            save();
            const contExtras = q(`#extras-${sp.id}`); 
            if(contExtras) renderExtrasList(contExtras, sp);
            renderResults();
          }
          return;
        }

        const spIdx = spaces.findIndex(x=>x.id===id); 
        if(spIdx<0) return;
        if(act==='del'){
          spaces.splice(spIdx,1); 
          save(); 
          renderSpaces(); 
          renderResults(); 
          return; 
        }
        if(act==='dup'){
          const clone = JSON.parse(JSON.stringify(spaces[spIdx])); 
          clone.id='S'+(idSeq++); 
          clone.name = clone.name + ' (복제)'; 
          spaces.splice(spIdx+1,0,clone); 
          save(); 
          renderSpaces(); 
          renderResults(); 
          return; 
        }
      });
    }

    // ===== 공간 추가/복제 (위임) =====
    document.addEventListener('click', (e)=>{
      const addBtn = e.target.closest('#addSpace');
      if(addBtn){ 
        e.preventDefault(); 
        spaces.push(newSpace()); 
        save(); 
        renderSpaces(); 
        renderResults(); 
        return; 
      }
      const dupBtn = e.target.closest('#dupLast');
      if(dupBtn){ 
        e.preventDefault(); 
        if(!spaces.length) return; 
        const c = JSON.parse(JSON.stringify(spaces[spaces.length-1])); 
        c.id='S'+(idSeq++); 
        c.name=c.name+' (복제)'; 
        spaces.push(c); 
        save(); 
        renderSpaces(); 
        renderResults(); 
        return; 
      }
    });

    // VAT 토글
    q('#vatToggle').addEventListener('change', (e)=>{ globalVat = e.target.checked; save(); renderResults(); });

    // ===== 링크 공유/엑셀 출력 =====
    function copyShareUrl(){
      const url = location.href;
      if(!(navigator.clipboard && window.isSecureContext)){
        prompt('아래 링크를 복사하세요', url); return;
      }
      navigator.clipboard.writeText(url).then(()=>{ alert('현재 설정 링크를 복사했습니다.'); }).catch(()=>{ prompt('아래 링크를 복사하세요', url); });
    }
    q('#share').addEventListener('click', copyShareUrl);

    function xmlEscape(s){
      return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    }
    function buildExcelXML(){
      const results = spaces.map(sp=>({ sp, r: calcSpace(sp) }));
      let monthlySum = results.reduce((acc,cur)=> acc + cur.r.monthly, 0);
      const vatAmt = globalVat ? monthlySum*0.1 : 0;
      const grand = monthlySum + vatAmt;

      const header = `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">
<Styles>
<Style ss:ID="n"><NumberFormat ss:Format="#,##0"/></Style>
<Style ss:ID="p"><Font ss:Bold="1"/></Style>
</Styles>`;

      // 요약 시트
      let sheet1 = `<Worksheet ss:Name="요약"><Table>`;
      sheet1 += `<Row><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">공간명</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">회당(원)</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">방문/월</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">할인(%)</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">추가(月)</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">월 합계(원)</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">비고</Data></Cell></Row>`;
      for(const {sp,r} of results){
        sheet1 += `<Row>`+
          `<Cell><Data ss:Type=\"String\">${xmlEscape(sp.name)}</Data></Cell>`+
          `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.perVisit)}</Data></Cell>`+
          `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${r.visits}</Data></Cell>`+
          `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.disc*100)}</Data></Cell>`+
          `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.extrasMonthly)}</Data></Cell>`+
          `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.monthly)}</Data></Cell>`+
          `<Cell><Data ss:Type=\"String\">${xmlEscape(sp.note||'')}</Data></Cell>`+
        `</Row>`;
      }
      sheet1 += `<Row><Cell ss:MergeAcross=\"5\"><Data ss:Type=\"String\">월 합계(부가세 제외)</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(monthlySum)}</Data></Cell></Row>`;
      sheet1 += `<Row><Cell ss:MergeAcross=\"5\"><Data ss:Type=\"String\">부가세 10%</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(vatAmt)}</Data></Cell></Row>`;
      sheet1 += `<Row><Cell ss:MergeAcross=\"5\"><Data ss:Type=\"String\">총 청구액(부가세 포함)</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(grand)}</Data></Cell></Row>`;
      sheet1 += `</Table></Worksheet>`;

      // 상세 시트
      let sheet2 = `<Worksheet ss:Name=\"상세\"><Table>`;
      for(const {sp,r} of results){
        sheet2 += `<Row><Cell ss:StyleID=\"p\" ss:MergeAcross=\"2\"><Data ss:Type=\"String\">${xmlEscape(sp.name)}</Data></Cell></Row>`;
        sheet2 += `<Row><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">항목</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">단가/산식</Data></Cell><Cell ss:StyleID=\"p\"><Data ss:Type=\"String\">금액(원)</Data></Cell></Row>`;
        for(const row of r.rows){
          sheet2 += `<Row>`+
            `<Cell><Data ss:Type=\"String\">${xmlEscape(row[0])}</Data></Cell>`+
            `<Cell><Data ss:Type=\"String\">${xmlEscape(row[1])}</Data></Cell>`+
            `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(row[2]||0)}</Data></Cell>`+
          `</Row>`;
        }
        if(r.extrasItems.length){
          sheet2 += `<Row/>`;
          sheet2 += `<Row><Cell ss:StyleID=\"p\" ss:MergeAcross=\"2\"><Data ss:Type=\"String\">추가 비용(월)</Data></Cell></Row>`;
          for(const it of r.extrasItems){
            sheet2 += `<Row>`+
              `<Cell><Data ss:Type=\"String\">추가(월)</Data></Cell>`+
              `<Cell><Data ss:Type=\"String\">${xmlEscape(it.label||'-')}</Data></Cell>`+
              `<Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(Number(it.amount)||0)}</Data></Cell>`+
            `</Row>`;
          }
          sheet2 += `<Row><Cell ss:MergeAcross=\"1\"><Data ss:Type=\"String\">추가 합계(월)</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.extrasMonthly)}</Data></Cell></Row>`;
        }
        sheet2 += `<Row><Cell ss:MergeAcross=\"1\"><Data ss:Type=\"String\">회당 합계</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.perVisit)}</Data></Cell></Row>`;
        sheet2 += `<Row><Cell ss:MergeAcross=\"1\"><Data ss:Type=\"String\">방문/월 · 할인(%)</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${r.visits}</Data></Cell></Row>`;
        sheet2 += `<Row><Cell ss:MergeAcross=\"1\"><Data ss:Type=\"String\">월 합계</Data></Cell><Cell ss:StyleID=\"n\"><Data ss:Type=\"Number\">${Math.round(r.monthly)}</Data></Cell></Row>`;
        if(sp.note){ sheet2 += `<Row><Cell ss:MergeAcross=\"2\"><Data ss:Type=\"String\">비고: ${xmlEscape(sp.note)}</Data></Cell></Row>`; }
        sheet2 += `<Row/>`;
      }
      sheet2 += `</Table></Worksheet>`;

      const footer = `</Workbook>`;
      return header + sheet1 + sheet2 + footer;
    }

    function exportExcel(){
      const xml = buildExcelXML();
      try{
        if(!(xml.includes('<Workbook') && xml.includes('요약'))) throw new Error('엑셀 XML 생성 실패');
      }catch(e){
        alert('엑셀 생성 중 문제가 발생했습니다. 콘솔을 확인하세요.');
        console.error(e);
        return;
      }
      const blob = new Blob([xml], {type:'application/vnd.ms-excel'});
      const url = URL.createObjectURL(blob);
      const ts = new Date();
      const pad=(n)=>String(n).padStart(2,'0');
      const fname = `정기청소_견적서_${ts.getFullYear()}${pad(ts.getMonth()+1)}${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}.xls`;
      const a = document.createElement('a');
      a.href = url; a.download = fname; document.body.appendChild(a); a.click(); a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }
    q('#print').addEventListener('click', exportExcel);

    // ===== 상태 저장/복원 =====
    function save(){
      const state = {spaces, vat: globalVat}; const s = encodeURIComponent(JSON.stringify(state)); history.replaceState(null,'','#s='+s);
    }
    function load(){
      if(!location.hash.startsWith('#s=')) return;
      try{ const raw = decodeURIComponent(location.hash.slice(3)); const state = JSON.parse(raw);
        if(state.spaces) spaces = state.spaces; if(typeof state.vat==='boolean') globalVat = state.vat;
      }catch(e){ console.warn('복원 실패', e); }
    }

    // ===== 간단 테스트 (콘솔 & 배지) =====
    function approxEqual(a,b,eps=1){ return Math.abs(a-b) <= eps; }
    function runTests(){
      const tests = [];
      const base = () => ({ pyeong:10,difficulty:1,basePerPyeong:8000,freqPerWeek:1,discountRate:0,discountCustom:false,satOn:false,sunOn:false,satRate:0.10,sunRate:0.20,addons:{restroom:false,stairs:false,trash:false,windows:false,officeRooms:false,meetingRooms:false,extras:true},restrooms:0,restroomAdd:5000,stairsFloors:0,stairsAdd:3000,trashLevel:0,trashPrice:10000,windows:0,windowInternal:20000,officeCount:0,officeUnit:5000,meetingCount:0,meetingUnit:7000,extras:[],note:''});

      // T1: 기본(10평, 주1) → perVisit 80,000 / monthly 320,000
      tests.push(()=>{ const sp = base(); const r=calcSpace(sp); return approxEqual(r.perVisit,80000)&&approxEqual(r.monthly,320000); });
      // T2: 화장실 2개 가산 → perVisit 90,000 / monthly 360,000
      tests.push(()=>{ const sp = base(); sp.addons.restroom=true; sp.restrooms=2; const r=calcSpace(sp); return approxEqual(r.perVisit,90000)&&approxEqual(r.monthly,360000); });
      // T3: 토요일 가산 10% → perVisit 88,000 / monthly 352,000
      tests.push(()=>{ const sp = base(); sp.satOn=true; const r=calcSpace(sp); return approxEqual(r.perVisit,88000)&&approxEqual(r.monthly,352000); });
      // T4: 추가 비용(월) 15,000 → monthly 320,000 + 15,000 = 335,000
      tests.push(()=>{ const sp = base(); sp.extras=[{label:'A',amount:10000},{label:'B',amount:5000}]; const r=calcSpace(sp); return approxEqual(r.monthly,335000)&&approxEqual(r.extrasMonthly,15000); });
      // T5: 방문 12회(주3) 할인 8% → 80,000×12×0.92
      tests.push(()=>{ const sp = base(); sp.freqPerWeek=3; const r=calcSpace(sp); return approxEqual(r.monthly, (80000*12)*(1-0.08) ); });
      // T6: 유리 내부 포함(20,000) → perVisit 100,000
      tests.push(()=>{ const sp = base(); sp.addons.windows=true; sp.windows=1; const r=calcSpace(sp); return approxEqual(r.perVisit,100000); });
      // T7: 사무실 3×5,000 + 회의실 2×7,000 → perVisit 80,000 + 15,000 + 14,000 = 109,000
      tests.push(()=>{ const sp = base(); sp.addons.officeRooms=true; sp.officeCount=3; sp.officeUnit=5000; sp.addons.meetingRooms=true; sp.meetingCount=2; sp.meetingUnit=7000; const r=calcSpace(sp); return approxEqual(r.perVisit,109000); });
      // 추가 테스트
      // T8: 사용자 지정 할인 10% (주3 기본 8% 무시)
      tests.push(()=>{ const sp = base(); sp.freqPerWeek=3; sp.discountRate=0.10; sp.discountCustom=true; const r=calcSpace(sp); return approxEqual(r.monthly, (80000*12)*(1-0.10)); });
      // T9: 주말 토10%·일20% 동시 → 1.1×1.2=1.32 배
      tests.push(()=>{ const sp = base(); sp.satOn=true; sp.sunOn=true; const r=calcSpace(sp); return approxEqual(r.perVisit, 80000*1.32) && approxEqual(r.monthly, 320000*1.32); });
      // T10: 분리수거 대량(×1.5) 단가 10,000 → perVisit 95,000
      tests.push(()=>{ const sp = base(); sp.addons.trash=true; sp.trashLevel=2; const r=calcSpace(sp); return approxEqual(r.perVisit, 95000); });
      // T11: 사무실/회의실 포함 월 합계 (perVisit 109,000 × 4)
      tests.push(()=>{ const sp = base(); sp.addons.officeRooms=true; sp.officeCount=3; sp.officeUnit=5000; sp.addons.meetingRooms=true; sp.meetingCount=2; sp.meetingUnit=7000; const r=calcSpace(sp); return approxEqual(r.monthly, 109000*4); });

      const pass = tests.every(fn=>{ try{return !!fn();}catch{ return false; } });
      const badge = q('#testStatus');
      if(pass){ badge.textContent='자가 테스트: 통과'; badge.classList.remove('test-fail'); badge.classList.add('test-pass'); badge.style.display='inline-block'; }
      else{ badge.textContent='자가 테스트: 실패'; badge.classList.remove('test-pass'); badge.classList.add('test-fail'); badge.style.display='inline-block'; }
    }

    // ===== 초기화 =====
    function init(){
      load();
      if(spaces.length===0){ spaces.push(newSpace()); }
      q('#vatToggle').checked = globalVat;
      renderSpaces();
      renderResults();
      bindSpaces();
      runTests();
    }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
  </script>
</body>
</html>
